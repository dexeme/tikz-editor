<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikZ Editor</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="styles/tailwind.generated.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
</head>
<body class="bg-slate-950 text-slate-200 font-[Inter] antialiased">
  <div id="app" v-cloak class="flex h-screen">
    <transition name="fade">
      <div
        v-if="feedback"
        class="fixed left-1/2 top-6 z-50 -translate-x-1/2 rounded-full bg-indigo-500 px-5 py-2 text-sm font-semibold text-white shadow-xl"
        role="status"
        aria-live="polite"
      >
        {{ feedback }}
      </div>
    </transition>

    <div class="flex flex-1 overflow-hidden">
      <div class="flex flex-1 flex-col overflow-hidden">
        <header class="app-header">
          <div class="app-header-left">
            <div class="app-brand">
              <div class="app-brand-icon">∿</div>
              <div class="app-brand-text">
                <p>Editor</p>
                <h1>TikZ</h1>
              </div>
            </div>
            <div class="file-menu-trigger" ref="diagramMenuButtonRef">
              <button
                type="button"
                class="file-button"
                @click="toggleDiagramMenu"
                :aria-expanded="showDiagramMenu ? 'true' : 'false'"
                aria-controls="diagram-menu"
              >
                File
              </button>
              <div
                v-if="showDiagramMenu"
                id="diagram-menu"
                ref="diagramMenuRef"
                class="file-menu"
                role="menu"
              >
                <button type="button" role="menuitem" @click="closeDiagramMenu(); triggerLoadDiagram()">
                  <span>Load diagram…</span>
                </button>
                <button type="button" role="menuitem" :disabled="!canReset" @click="closeDiagramMenu(); saveDiagram()">
                  <span>Save diagram…</span>
                </button>
                <button type="button" role="menuitem" :disabled="!tikzCode" @click="closeDiagramMenu(); copyToClipboard()">
                  <span>Copy TikZ code</span>
                </button>
                <button type="button" role="menuitem" @click="closeDiagramMenu(); triggerMatrixImport()">
                  <span>Import matrix…</span>
                </button>
              </div>
            </div>
          </div>
          <div class="app-header-right">
            <button
              type="button"
              class="icon-button"
              :class="{ active: showTemplateBrowser }"
              @click="toggleTemplateBrowser"
              aria-label="Open template gallery"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l3 7h7l-5.5 4.5L18 21l-6-4-6 4 1.5-7.5L2 9h7z" />
              </svg>
            </button>
            <button
              type="button"
              class="icon-button"
              :class="{ active: showSettingsDialog }"
              @click="toggleSettingsDialog"
              aria-label="Open settings"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11.25 3.5h1.5l.45 2.4a6.5 6.5 0 0 1 1.74.72l2.2-1.26 1.06 1.06-1.26 2.2c.27.54.5 1.13.66 1.74l2.43.44v1.5l-2.43.45a6.6 6.6 0 0 1-.66 1.74l1.26 2.2-1.06 1.06-2.2-1.26a6.5 6.5 0 0 1-1.74.72l-.45 2.4h-1.5l-.45-2.4a6.5 6.5 0 0 1-1.74-.72l-2.2 1.26-1.06-1.06 1.26-2.2a6.6 6.6 0 0 1-.66-1.74l-2.43-.45v-1.5l2.43-.45c.16-.61.39-1.2.66-1.74l-1.26-2.2 1.06-1.06 2.2 1.26a6.5 6.5 0 0 1 1.74-.72l.45-2.4z" />
                <circle cx="12" cy="12" r="2.5" />
              </svg>
            </button>
            <button type="button" class="primary-button" @click="copyToClipboard" :disabled="!tikzCode">
              Copy TikZ
            </button>
          </div>
        </header>

        <main class="flex flex-1 overflow-hidden">
          <section class="flex flex-1 flex-col overflow-hidden">
            <div class="relative flex-1 overflow-hidden p-6">
              <div class="canvas-shell">
                <div class="absolute inset-0 rounded-3xl canvas-grid"></div>

                <div class="relative z-10 flex h-full flex-col">
                  <div class="flex-1 p-6">
                    <div
                      class="canvas-wrapper"
                      ref="canvasWrapperRef"
                      :class="{ 'is-panning': isPanningActive, 'is-drawing': ['forms', 'frame', 'line'].includes(mode) }"
                      @contextmenu.prevent="openContextMenu"
                    >
                      <div
                        v-if="selectedNode"
                        ref="nodeToolbarRef"
                        class="selection-toolbar"
                        role="toolbar"
                        aria-label="Selected node options"
                        :style="nodeToolbarStyle"
                      >
                        <div
                          v-if="selectedNodes.length > 1"
                          class="selection-toolbar-meta"
                          aria-live="polite"
                        >
                          Applying to {{ selectedNodes.length }} nodes
                        </div>
                        <div class="selection-toolbar-row">
                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('fill')" @mouseleave="setNodeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: nodeToolbarState.activePopover === 'fill' }"
                              @click.stop="toggleNodePopover('fill')"
                              aria-label="Fill color"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M12 3.2c3.1 3.6 4.9 6.3 4.9 8.9a4.9 4.9 0 1 1-9.8 0c0-2.6 1.8-5.3 4.9-8.9z" />
                                  <path d="M8.4 14.6a3.6 3.6 0 0 0 7.2 0" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="nodeToolbarState.activePopover === 'fill'" class="selection-popover">
                              <div v-if="recentColorPalette.length" class="swatch-group">
                                <p class="swatch-group-label">Recent</p>
                                <div class="swatch-grid">
                                  <button
                                    v-for="color in recentColorPalette"
                                    :key="`recent-fill-${color}`"
                                    type="button"
                                    class="swatch"
                                    :style="{ backgroundColor: color }"
                                    :aria-label="`Apply color ${color}`"
                                    @click="applyNodeFill(color)"
                                  ></button>
                                </div>
                              </div>
                              <div class="swatch-group">
                                <p class="swatch-group-label">Palette</p>
                                <div class="swatch-grid">
                                  <button
                                    v-for="color in nodeFillPalette"
                                    :key="`fill-${color}`"
                                    type="button"
                                    class="swatch"
                                    :style="{ backgroundColor: color }"
                                    :aria-label="`Apply color ${color}`"
                                    @click="applyNodeFill(color)"
                                  ></button>
                                </div>
                              </div>
                              <div class="custom-color-picker">
                                <input
                                  type="color"
                                  :value="nodeToolbarState.fillCustomColor"
                                  @input="applyNodeFill($event.target.value, { commit: false })"
                                  @change="applyNodeFill($event.target.value, { forceCommit: true })"
                                >
                                <button type="button" @click="addCustomColor('fill')">Add to palette</button>
                              </div>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('stroke')" @mouseleave="setNodeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: nodeToolbarState.activePopover === 'stroke' }"
                              @click.stop="toggleNodePopover('stroke')"
                              aria-label="Border color"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M16.6 3.6l3.8 3.8-3 3" />
                                  <path d="M8.2 12.8l7.2-7.2 2.9 2.9-7.2 7.2-4.3 1.4 1.4-4.3z" />
                                  <path d="M5.4 19.4l2.4-2.4" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="nodeToolbarState.activePopover === 'stroke'" class="selection-popover">
                              <div v-if="recentColorPalette.length" class="swatch-group">
                                <p class="swatch-group-label">Recent</p>
                                <div class="swatch-grid">
                                  <button
                                    v-for="color in recentColorPalette"
                                    :key="`recent-stroke-${color}`"
                                    type="button"
                                    class="swatch"
                                    :style="{ backgroundColor: color }"
                                    :aria-label="`Apply border color ${color}`"
                                    @click="applyNodeBorder(color)"
                                  ></button>
                                </div>
                              </div>
                              <div class="swatch-group">
                                <p class="swatch-group-label">Palette</p>
                                <div class="swatch-grid">
                                  <button
                                    v-for="color in nodeStrokePalette"
                                    :key="`stroke-${color}`"
                                    type="button"
                                    class="swatch"
                                    :style="{ backgroundColor: color }"
                                    :aria-label="`Apply border color ${color}`"
                                    @click="applyNodeBorder(color)"
                                  ></button>
                                </div>
                              </div>
                              <div class="custom-color-picker">
                                <input
                                  type="color"
                                  :value="nodeToolbarState.strokeCustomColor"
                                  @input="applyNodeBorder($event.target.value, { commit: false })"
                                  @change="applyNodeBorder($event.target.value, { forceCommit: true })"
                                >
                                <button type="button" @click="addCustomColor('stroke')">Add to palette</button>
                              </div>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('borderWidth')" @mouseleave="setNodeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: nodeToolbarState.activePopover === 'borderWidth' }"
                              @click.stop="toggleNodePopover('borderWidth')"
                              aria-label="Border width"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round">
                                  <path d="M5 7h14" stroke-width="1.4" />
                                  <path d="M5 12h14" stroke-width="2.2" />
                                  <path d="M5 17h14" stroke-width="1" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="nodeToolbarState.activePopover === 'borderWidth'" class="selection-popover selection-popover--wide">
                              <div class="slider-control">
                                <span>Thickness: {{ Number(selectedNode.borderWidth ?? 3).toFixed(1) }} px</span>
                                <input
                                  type="range"
                                  min="1"
                                  max="8"
                                  step="0.5"
                                  :value="selectedNode.borderWidth"
                                  @input="updateNodeBorderWidth($event.target.value, { commit: false })"
                                  @change="updateNodeBorderWidth($event.target.value, { forceCommit: true })"
                                >
                              </div>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('cornerRadius')" @mouseleave="setNodeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: nodeToolbarState.activePopover === 'cornerRadius' }"
                              @click.stop="toggleNodePopover('cornerRadius')"
                              aria-label="Corner radius"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <rect x="5" y="5" width="14" height="14" rx="4" />
                                  <path d="M9 5v2a2 2 0 0 0 2 2h2" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="nodeToolbarState.activePopover === 'cornerRadius'" class="selection-popover selection-popover--wide">
                              <div class="slider-control">
                                <span>Radius: {{ Math.round(Number(selectedNode.cornerRadius ?? 16)) }} px</span>
                                <input
                                  type="range"
                                  min="0"
                                  max="64"
                                  step="1"
                                  :value="selectedNode.cornerRadius"
                                  @input="updateNodeCornerRadius($event.target.value, { commit: false })"
                                  @change="updateNodeCornerRadius($event.target.value, { forceCommit: true })"
                                >
                              </div>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('fontSize')" @mouseleave="setNodeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: nodeToolbarState.activePopover === 'fontSize' }"
                              @click.stop="toggleNodePopover('fontSize')"
                              aria-label="Font size"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M5 7h14" />
                                  <path d="M12 7v11" />
                                  <path d="M8 18h8" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="nodeToolbarState.activePopover === 'fontSize'" class="selection-popover">
                              <div class="chip-grid">
                                <button
                                  v-for="option in fontSizeOptions"
                                  :key="`font-${option}`"
                                  type="button"
                                  class="chip"
                                  :class="{ active: selectedNode.fontSize === option }"
                                  @click="setNodeFontSize(option)"
                                >
                                  {{ option }}
                                </button>
                              </div>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('shape')" @mouseleave="setNodeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: nodeToolbarState.activePopover === 'shape' }"
                              @click.stop="toggleNodePopover('shape')"
                              aria-label="Node shape"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <rect x="5" y="5" width="14" height="14" rx="3" />
                                  <circle cx="12" cy="12" r="4.5" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="nodeToolbarState.activePopover === 'shape'" class="selection-popover">
                              <div class="shape-grid">
                                <button
                                  v-for="shape in availableShapes"
                                  :key="`shape-${shape.id}`"
                                  type="button"
                                  class="chip"
                                  :class="{ active: selectedNode.shape === shape.id }"
                                  @click="setNodeShape(shape.id)"
                                >
                                  <span class="shape-icon" aria-hidden="true">
                                    <svg v-if="shape.id === 'rectangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <rect x="5" y="6" width="14" height="12" rx="2" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'rounded rectangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <rect x="5" y="6" width="14" height="12" rx="5" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'rectangle split'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <rect x="5" y="5" width="14" height="14" rx="2" />
                                      <path d="M5 10.5h14" />
                                      <path d="M5 15h14" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'circle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <circle cx="12" cy="12" r="6.5" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'ellipse'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <ellipse cx="12" cy="12" rx="6.5" ry="4.5" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'semicircle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <path d="M6 16.5h12a6 6 0 0 0-12 0z" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'triangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 18h15L12 6z" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'diamond'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3l7 9-7 9-7-9 7-9z" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'decision'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4l7 8-7 8-7-8 7-8z" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'cylinder'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                      <ellipse cx="12" cy="7" rx="5.5" ry="2.5" />
                                      <path d="M6.5 7v8.5" />
                                      <path d="M17.5 7v8.5" />
                                      <path d="M6.5 15.5c0 1.4 2.46 2.5 5.5 2.5s5.5-1.1 5.5-2.5" />
                                    </svg>
                                    <svg v-else-if="shape.id === 'cloud'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M7 17.5h9.5a3.5 3.5 0 0 0 .5-7 4.5 4.5 0 0 0-8.5-2 3 3 0 0 0-.5 6z" />
                                    </svg>
                                  </span>
                                  <span>{{ shape.label }}</span>
                                </button>
                              </div>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('copy')" @mouseleave="setNodeToolbarHover(null)">
                            <button type="button" class="toolbar-action" @click="copySelectedFormatting" aria-label="Copy formatting">
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <rect x="9" y="9" width="10" height="10" rx="2" />
                                  <rect x="5" y="5" width="10" height="10" rx="2" />
                                </svg>
                              </span>
                            </button>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('paste')" @mouseleave="setNodeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ disabled: !canPasteFormatting }"
                              :disabled="!canPasteFormatting"
                              @click="pasteSelectedFormatting"
                              aria-label="Paste formatting"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <rect x="6" y="6" width="12" height="14" rx="2" />
                                  <path d="M9 4h6a1 1 0 0 1 1 1v1H8V5a1 1 0 0 1 1-1z" />
                                  <path d="M12 11v5" />
                                  <path d="M10.5 14.5L12 16l1.5-1.5" />
                                </svg>
                              </span>
                            </button>
                          </div>

                          <div class="toolbar-item" @mouseenter="setNodeToolbarHover('remove')" @mouseleave="setNodeToolbarHover(null)">
                            <button type="button" class="toolbar-action danger" @click="removeSelected" aria-label="Remove node">
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M6 7h12" />
                                  <path d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                                  <rect x="7" y="7" width="10" height="12" rx="1" />
                                  <path d="M10 11v6" />
                                  <path d="M14 11v6" />
                                </svg>
                              </span>
                            </button>
                          </div>
                        </div>
                        <div v-if="nodeToolbarHint" class="selection-toolbar-hint">{{ nodeToolbarHint }}</div>
                      </div>

                      <div
                        v-if="selectedEdge"
                        ref="edgeToolbarRef"
                        class="selection-toolbar edge-toolbar"
                        role="toolbar"
                        aria-label="Selected edge options"
                        :style="edgeToolbarStyle"
                      >
                        <div class="selection-toolbar-row">
                          <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('color')" @mouseleave="setEdgeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: edgeToolbarState.activePopover === 'color' }"
                              @click.stop="toggleEdgePopover('color')"
                              aria-label="Edge color"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M12 3.2c3.1 3.6 4.9 6.3 4.9 8.9a4.9 4.9 0 1 1-9.8 0c0-2.6 1.8-5.3 4.9-8.9z" />
                                  <path d="M8.4 14.6a3.6 3.6 0 0 0 7.2 0" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="edgeToolbarState.activePopover === 'color'" class="selection-popover">
                              <div v-if="recentColorPalette.length" class="swatch-group">
                                <p class="swatch-group-label">Recent</p>
                                <div class="swatch-grid">
                                  <button
                                    v-for="color in recentColorPalette"
                                    :key="`edge-recent-${color}`"
                                    type="button"
                                    class="swatch"
                                    :style="{ backgroundColor: color }"
                                    :aria-label="`Apply color ${color}`"
                                    @click="applyEdgeColor(color)"
                                  ></button>
                                </div>
                              </div>
                              <div class="swatch-group">
                                <p class="swatch-group-label">Palette</p>
                                <div class="swatch-grid">
                                  <button
                                    v-for="color in nodeStrokePalette"
                                    :key="`edge-color-${color}`"
                                    type="button"
                                    class="swatch"
                                    :style="{ backgroundColor: color }"
                                    :aria-label="`Apply color ${color}`"
                                    @click="applyEdgeColor(color)"
                                  ></button>
                                </div>
                              </div>
                              <div class="custom-color-picker">
                                <input
                                  type="color"
                                  :value="edgeToolbarState.customColor"
                                  @input="applyEdgeColor($event.target.value, { commit: false })"
                                  @change="applyEdgeColor($event.target.value, { forceCommit: true })"
                                >
                                <button type="button" @click="addCustomColor('stroke')">Add to palette</button>
                              </div>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('style')" @mouseleave="setEdgeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: edgeToolbarState.activePopover === 'style' }"
                              @click.stop="toggleEdgePopover('style')"
                              aria-label="Line style"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round">
                                  <path d="M5 9h14" stroke-width="1.6" />
                                  <path d="M5 12h14" stroke-width="1.6" stroke-dasharray="3 2" />
                                  <path d="M5 15h14" stroke-width="1.6" stroke-dasharray="1 3" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="edgeToolbarState.activePopover === 'style'" class="selection-popover selection-popover--compact">
                              <button type="button" class="chip" :class="{ active: selectedEdge.style === 'solid' }" @click="setEdgeStyle('solid')">Solid</button>
                              <button type="button" class="chip" :class="{ active: selectedEdge.style === 'dashed' }" @click="setEdgeStyle('dashed')">Tracejada</button>
                              <button type="button" class="chip" :class="{ active: selectedEdge.style === 'dotted' }" @click="setEdgeStyle('dotted')">Pontilhada</button>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('direction')" @mouseleave="setEdgeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: edgeToolbarState.activePopover === 'direction' }"
                              @click.stop="toggleEdgePopover('direction')"
                              aria-label="Edge direction"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M5 12h14" />
                                  <path d="M15 8l4 4-4 4" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="edgeToolbarState.activePopover === 'direction'" class="selection-popover selection-popover--compact">
                              <div class="chip-grid">
                                <button type="button" class="chip" :class="{ active: selectedEdge.direction === '->' }" @click="setEdgeDirection('->')">-&gt;</button>
                                <button type="button" class="chip" :class="{ active: selectedEdge.direction === '<-' }" @click="setEdgeDirection('<-')">&lt;-</button>
                                <button type="button" class="chip" :class="{ active: selectedEdge.direction === '<->' }" @click="setEdgeDirection('<->')">&lt;-&gt;</button>
                                <button type="button" class="chip" :class="{ active: selectedEdge.direction === '-' }" @click="setEdgeDirection('-')">-</button>
                              </div>
                              <button type="button" class="toolbar-link" @click="flipEdgeDirection">Flip direction</button>
                            </div>
                          </div>

                          <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('thickness')" @mouseleave="setEdgeToolbarHover(null)">
                            <button
                              type="button"
                              class="toolbar-action"
                              :class="{ active: edgeToolbarState.activePopover === 'thickness' }"
                              @click.stop="toggleEdgePopover('thickness')"
                              aria-label="Edge thickness"
                            >
                              <span class="toolbar-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round">
                                  <path d="M9 6v12" stroke-width="1.4" />
                                  <path d="M15 6v12" stroke-width="2.4" />
                                </svg>
                              </span>
                            </button>
                            <div v-if="edgeToolbarState.activePopover === 'thickness'" class="selection-popover selection-popover--wide">
                              <div class="slider-control">
                                <span>
                                  {{
                                    selectedEdge.thickness
                                      ? 'Custom: ' + Number(selectedEdge.thickness).toFixed(1) + ' px'
                                      : 'Using default: ' + edgeThicknessDisplay
                                  }}
                                </span>
                                <input
                                  type="range"
                                  min="1"
                                  max="8"
                                  step="0.5"
                                  :value="selectedEdge.thickness ?? edgeThickness"
                                  @input="updateSelectedEdgeThickness($event.target.value, { commit: false })"
                                  @change="updateSelectedEdgeThickness($event.target.value, { forceCommit: true })"
                                >
                                <button type="button" class="chip" @click="clearEdgeThickness" :disabled="selectedEdge.thickness == null">
                                  Use global default
                                </button>
                              </div>
                            </div>
                          </div>

                            <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('copy')" @mouseleave="setEdgeToolbarHover(null)">
                              <button type="button" class="toolbar-action" @click="copySelectedFormatting" aria-label="Copy edge formatting">
                                <span class="toolbar-icon" aria-hidden="true">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="10" height="10" rx="2" />
                                    <rect x="5" y="5" width="10" height="10" rx="2" />
                                  </svg>
                                </span>
                              </button>
                            </div>

                            <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('paste')" @mouseleave="setEdgeToolbarHover(null)">
                              <button
                                type="button"
                                class="toolbar-action"
                                :class="{ disabled: !canPasteFormatting }"
                                :disabled="!canPasteFormatting"
                                @click="pasteSelectedFormatting"
                                aria-label="Paste edge formatting"
                              >
                                <span class="toolbar-icon" aria-hidden="true">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="6" y="6" width="12" height="14" rx="2" />
                                    <path d="M9 4h6a1 1 0 0 1 1 1v1H8V5a1 1 0 0 1 1-1z" />
                                    <path d="M12 11v5" />
                                    <path d="M10.5 14.5L12 16l1.5-1.5" />
                                  </svg>
                                </span>
                              </button>
                            </div>

                          <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('alignment')" @mouseleave="setEdgeToolbarHover(null)">
                              <button
                                type="button"
                                class="toolbar-action"
                                :class="{ active: edgeToolbarState.activePopover === 'alignment', disabled: !hasSelectedEdgeLabel }"
                                :disabled="!hasSelectedEdgeLabel"
                                :title="hasSelectedEdgeLabel ? 'Label alignment' : 'Add an edge label to enable'"
                                @click.stop="toggleEdgePopover('alignment')"
                                aria-label="Label alignment"
                              >
                                <span class="toolbar-icon" aria-hidden="true">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6 6h12" />
                                    <path d="M12 6v12" />
                                    <path d="M8 12h8" />
                                    <path d="M9.5 16h5" />
                                  </svg>
                                </span>
                              </button>
                            <div v-if="edgeToolbarState.activePopover === 'alignment'" class="selection-popover selection-popover--compact">
                              <button type="button" class="chip" :class="{ active: selectedEdge.label?.alignment === 'auto' || !selectedEdge.label?.alignment }" @click="setEdgeLabelAlignment('auto')">Auto</button>
                              <button type="button" class="chip" :class="{ active: selectedEdge.label?.alignment === 'left' }" @click="setEdgeLabelAlignment('left')">Left</button>
                              <button type="button" class="chip" :class="{ active: selectedEdge.label?.alignment === 'center' }" @click="setEdgeLabelAlignment('center')">Center</button>
                              <button type="button" class="chip" :class="{ active: selectedEdge.label?.alignment === 'right' }" @click="setEdgeLabelAlignment('right')">Right</button>
                            </div>
                          </div>

                            <div class="toolbar-item" @mouseenter="setEdgeToolbarHover('remove')" @mouseleave="setEdgeToolbarHover(null)">
                              <button type="button" class="toolbar-action danger" @click="removeSelected" aria-label="Remove edge">
                                <span class="toolbar-icon" aria-hidden="true">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6 7h12" />
                                    <path d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                                    <rect x="7" y="7" width="10" height="12" rx="1" />
                                    <path d="M10 11v6" />
                                    <path d="M14 11v6" />
                                  </svg>
                                </span>
                              </button>
                            </div>
                        </div>
                        <div v-if="edgeToolbarHint" class="selection-toolbar-hint">{{ edgeToolbarHint }}</div>
                      </div>

                      <canvas
                        ref="canvasRef"
                        width="1280"
                        height="900"
                        @mousedown="onCanvasMouseDown"
                        @mousemove="onCanvasMouseMove"
                        @mouseup="onCanvasMouseUp"
                        @mouseleave="onCanvasMouseUp"
                        @dblclick="onCanvasDblClick"
                        @wheel.prevent="onCanvasWheel"
                      ></canvas>
                      <div class="viewport-controls">
                        <div class="zoom-group" role="group" aria-label="Zoom controls">
                          <button type="button" @click="zoomOut">-</button>
                          <span>{{ zoomLevel }}%</span>
                          <button type="button" @click="zoomIn">+</button>
                        </div>
                        <button type="button" class="viewport-button" @click="resetView" aria-label="Center view">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5" />
                            <path d="M12 3v3" />
                            <path d="M12 18v3" />
                            <path d="M3 12h3" />
                            <path d="M18 12h3" />
                            <path d="M12 9v6" />
                            <path d="M9 12h6" />
                          </svg>
                        </button>
                      </div>
                      <div
                        v-if="inlineEditor.visible"
                        class="inline-editor"
                        :style="{
                          width: inlineEditor.width + 'px',
                          height: inlineEditor.height + 'px',
                          left: inlineEditor.left + 'px',
                          top: inlineEditor.top + 'px',
                        }"
                      >
                        <div class="inline-editor-body">
                          <div v-if="inlineEditorLineMarkers" class="inline-editor-gutter" aria-hidden="true">
                            <pre>{{ inlineEditorLineMarkers }}</pre>
                          </div>
                          <textarea
                            ref="inlineEditorRef"
                            v-model="inlineEditor.value"
                            @keydown="handleEditorKeydown"
                          ></textarea>
                        </div>
                        <div class="inline-editor-actions">
                          <button type="button" @mousedown.prevent @click="confirmInlineEditor">Save</button>
                          <button type="button" @mousedown.prevent @click="closeInlineEditor">Cancel</button>
                        </div>
                      </div>
                      <p class="canvas-hint">Click the canvas to {{ currentHint }}</p>
                    </div>
                  </div>
                  <div class="command-bar-container">
                    <div class="command-bar" role="toolbar" aria-label="Canvas tools">
                      <button
                        type="button"
                        class="command-button"
                        :class="{ active: mode === 'move' }"
                        @click="changeMode('move')"
                        aria-label="Move elements"
                        aria-keyshortcuts="V"
                      >
                        <span class="command-icon" aria-hidden="true">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5.2 3.5 18.5 11.4l-5.8 1.6 3.8 6.9-2.3 1.2-3.9-7.1-3.3 3.2z" />
                          </svg>
                        </span>
                        <span class="command-label">Move</span>
                        <span class="command-shortcut">V</span>
                      </button>
                      <button
                        type="button"
                        class="command-button"
                        :class="{ active: mode === 'frame' }"
                        @click="changeMode('frame')"
                        @dblclick.prevent="frame && focusFrame()"
                        aria-label="Frame"
                        aria-keyshortcuts="F"
                      >
                        <span class="command-icon" aria-hidden="true">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="4" y="4" width="16" height="16" rx="2" />
                            <rect x="8" y="8" width="8" height="8" rx="1.5" />
                          </svg>
                        </span>
                        <span class="command-label">Frame</span>
                        <span v-if="frame" class="command-indicator" aria-hidden="true"></span>
                        <span class="command-shortcut">F</span>
                      </button>
                      <button
                        v-if="frame"
                        type="button"
                        class="command-button command-button--danger"
                        @click="removeFrame"
                        aria-label="Remove frame"
                      >
                        <span class="command-icon" aria-hidden="true">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 7h12" />
                            <path d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                            <rect x="7" y="7" width="10" height="12" rx="1" />
                            <path d="M10 11v6" />
                            <path d="M14 11v6" />
                          </svg>
                        </span>
                        <span class="command-label">Remove frame</span>
                      </button>
                      <div
                        class="command-button command-button--forms"
                        :class="{ open: showFormsMenu, active: mode === 'forms' }"
                        ref="formsMenuAnchorRef"
                      >
                        <button
                          type="button"
                          class="command-button-main"
                          :aria-pressed="mode === 'forms' ? 'true' : 'false'"
                          @click="changeMode('forms')"
                          aria-label="Forms mode"
                        >
                          <span class="command-icon" aria-hidden="true">
                            <svg v-if="activeShape?.id === 'rectangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                              <rect x="5" y="6" width="14" height="12" rx="2" />
                            </svg>
                            <svg v-else-if="activeShape?.id === 'circle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                              <circle cx="12" cy="12" r="6.5" />
                            </svg>
                            <svg v-else-if="activeShape?.id === 'cylinder'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                              <ellipse cx="12" cy="7" rx="5.5" ry="2.5" />
                              <path d="M6.5 7v8.5" />
                              <path d="M17.5 7v8.5" />
                              <path d="M6.5 15.5c0 1.4 2.46 2.5 5.5 2.5s5.5-1.1 5.5-2.5" />
                            </svg>
                            <svg v-else-if="activeShape?.id === 'decision'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4l7 8-7 8-7-8 7-8z" />
                            </svg>
                            <svg v-else-if="activeShape?.id === 'diamond'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3l7 9-7 9-7-9 7-9z" />
                            </svg>
                            <svg v-else-if="activeShape?.id === 'triangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 18h15L12 6z" />
                            </svg>
                          </span>
                          <span class="command-label">Forms</span>
                        </button>
                        <button
                          type="button"
                          class="command-button-chevron"
                          @click.stop="toggleFormsMenu"
                          :aria-expanded="showFormsMenu ? 'true' : 'false'"
                          aria-label="Choose shape"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m8 10 4 4 4-4" />
                          </svg>
                        </button>
                        <div
                          v-if="showFormsMenu"
                          ref="formsMenuRef"
                          class="command-popover"
                          role="menu"
                        >
                          <button
                            v-for="shape in availableShapes"
                            :key="`shape-option-${shape.id}`"
                            type="button"
                            role="menuitem"
                            @click="selectShape(shape.id)"
                          >
                            <span class="shape-preview" aria-hidden="true">
                              <svg v-if="shape.id === 'rectangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <rect x="5" y="6" width="14" height="12" rx="2" />
                              </svg>
                              <svg v-else-if="shape.id === 'rounded rectangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <rect x="5" y="6" width="14" height="12" rx="5" />
                              </svg>
                              <svg v-else-if="shape.id === 'rectangle split'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <rect x="5" y="5" width="14" height="14" rx="2" />
                                <path d="M5 10.5h14" />
                                <path d="M5 15h14" />
                              </svg>
                              <svg v-else-if="shape.id === 'circle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <circle cx="12" cy="12" r="6.5" />
                              </svg>
                              <svg v-else-if="shape.id === 'ellipse'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <ellipse cx="12" cy="12" rx="6.5" ry="4.5" />
                              </svg>
                              <svg v-else-if="shape.id === 'semicircle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <path d="M6 16.5h12a6 6 0 0 0-12 0z" />
                              </svg>
                              <svg v-else-if="shape.id === 'triangle'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 18h15L12 6z" />
                              </svg>
                              <svg v-else-if="shape.id === 'diamond'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3l7 9-7 9-7-9 7-9z" />
                              </svg>
                              <svg v-else-if="shape.id === 'decision'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4l7 8-7 8-7-8 7-8z" />
                              </svg>
                              <svg v-else-if="shape.id === 'cylinder'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                <ellipse cx="12" cy="7" rx="5.5" ry="2.5" />
                                <path d="M6.5 7v8.5" />
                                <path d="M17.5 7v8.5" />
                                <path d="M6.5 15.5c0 1.4 2.46 2.5 5.5 2.5s5.5-1.1 5.5-2.5" />
                              </svg>
                              <svg v-else-if="shape.id === 'cloud'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M7 17.5h9.5a3.5 3.5 0 0 0 .5-7 4.5 4.5 0 0 0-8.5-2 3 3 0 0 0-.5 6z" />
                              </svg>
                            </span>
                            <span class="shape-label">{{ shape.label }}</span>
                            <span v-if="shape.shortcut" class="shape-shortcut">{{ shape.shortcut }}</span>
                          </button>
                        </div>
                      </div>
                      <button
                        type="button"
                        class="command-button"
                        :class="{ active: mode === 'line' }"
                        @click="changeMode('line')"
                        aria-label="Linha livre"
                        aria-keyshortcuts="L"
                      >
                        <span class="command-icon" aria-hidden="true">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 18 20 6" />
                          </svg>
                        </span>
                        <span class="command-label">Line</span>
                        <span class="command-shortcut">L</span>
                      </button>
                      <div
                        class="command-button command-button--menu"
                        :class="{ open: showLabelAlignmentMenu }"
                      >
                        <button
                          type="button"
                          class="command-button-main"
                          ref="labelAlignmentMenuButtonRef"
                          @click="toggleLabelAlignmentMenu"
                          :aria-expanded="showLabelAlignmentMenu ? 'true' : 'false'"
                          aria-label="Alinhamento global"
                        >
                          <span class="command-icon" aria-hidden="true">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 7h12" />
                              <path d="M9 12h6" />
                              <path d="M8 16h8" />
                            </svg>
                          </span>
                          <span class="command-label">Global alignment</span>
                        </button>
                        <div
                          v-if="showLabelAlignmentMenu"
                          ref="labelAlignmentMenuRef"
                          class="command-popover"
                          role="menu"
                        >
                          <label class="command-field">
                            <span>Default label position</span>
                            <select
                              :value="edgeLabelAlignment"
                              @change="onEdgeLabelAlignmentChange($event.target.value)"
                            >
                              <option value="auto">Automatic</option>
                              <option value="left">Left</option>
                              <option value="center">Centered</option>
                              <option value="right">Right</option>
                            </select>
                          </label>
                        </div>
                      </div>
                      <div
                        class="command-button command-button--menu"
                        :class="{ open: showEdgeThicknessMenu }"
                      >
                        <button
                          type="button"
                          class="command-button-main"
                          ref="edgeThicknessMenuButtonRef"
                          @click="toggleEdgeThicknessMenu"
                          :aria-expanded="showEdgeThicknessMenu ? 'true' : 'false'"
                          aria-label="Global thickness"
                        >
                          <span class="command-icon" aria-hidden="true">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M5 8.5h14" />
                              <path d="M5 12h10" />
                              <path d="M5 15.5h6" />
                            </svg>
                          </span>
                          <span class="command-label">Global stroke</span>
                        </button>
                        <div
                          v-if="showEdgeThicknessMenu"
                          ref="edgeThicknessMenuRef"
                          class="command-popover"
                          role="menu"
                        >
                          <div class="command-field">
                            <span>Global thickness</span>
                            <span class="command-value">{{ edgeThicknessDisplay }} px</span>
                          </div>
                          <input
                            type="range"
                            min="1"
                            max="8"
                            step="0.5"
                            :value="edgeThickness"
                            @input="updateEdgeThickness($event.target.value)"
                            @change="commitHistory"
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                  <div
                    v-if="contextMenu.visible"
                    ref="contextMenuRef"
                    class="canvas-context-menu"
                    :style="contextMenuStyle"
                    role="menu"
                  >
                    <button type="button" @click="closeContextMenu(); copySelection()" :disabled="!canCopySelection">
                      <span>Copy</span>
                      <span class="shortcut">Ctrl C</span>
                    </button>
                    <button type="button" @click="closeContextMenu(); pasteSelection()" :disabled="!canPasteClipboard">
                      <span>Paste</span>
                      <span class="shortcut">Ctrl V</span>
                    </button>
                    <button type="button" @click="closeContextMenu(); cutSelection()" :disabled="!canCutSelection">
                      <span>Cut</span>
                      <span class="shortcut">Ctrl X</span>
                    </button>
                    <button type="button" @click="closeContextMenu(); duplicateSelection()" :disabled="!canDuplicateSelection">
                      <span>Duplicate</span>
                      <span class="shortcut">Ctrl D</span>
                    </button>
                    <button type="button" @click="closeContextMenu(); copySelectedFormatting()" :disabled="!canCopyFormatting">
                      <span>Copy style</span>
                      <span class="shortcut">Ctrl ⇧ C</span>
                    </button>
                    <button type="button" @click="closeContextMenu(); pasteSelectedFormatting()" :disabled="!canPasteFormatting">
                      <span>Paste style</span>
                      <span class="shortcut">Ctrl ⇧ V</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <aside class="w-full max-w-md border-l border-slate-800 bg-slate-900/80 backdrop-blur">
            <div class="border-b border-slate-800">
              <nav class="flex">
                <button
                  v-if="inspectorVisible"
                  type="button"
                  class="tab"
                  :class="{ active: sidebarTab === 'inspect' }"
                  @click="setSidebarTab('inspect')"
                >
                  Inspect
                </button>
                <button
                  type="button"
                  class="tab"
                  :class="{ active: sidebarTab === 'code' }"
                  @click="setSidebarTab('code')"
                >
                  Code
                </button>
                <button
                  type="button"
                  class="tab"
                  :class="{ active: sidebarTab === 'preview' }"
                  @click="setSidebarTab('preview')"
                >
                  Preview
                </button>
              </nav>
            </div>
            <div class="sidebar-body" v-if="sidebarTab === 'inspect' && inspectorVisible">
              <section
                class="sidebar-panel"
                v-if="selected && selected.type === 'node'"
              >
                <header><h2>Edit node</h2></header>
                <div class="panel-content inspector-content">
                  <label class="inspector-field">
                    <span>Node label</span>
                    <textarea
                      class="inspector-textarea"
                      rows="5"
                      v-model="selected.item.label"
                      @input="invalidateTikz"
                      @change="commitHistory"
                    ></textarea>
                  </label>
                  <div class="inspector-grid">
                    <label class="inspector-field">
                      <span>Fill color</span>
                      <input
                        type="color"
                        :value="selected.item.color"
                        @input="applyNodeFill($event.target.value, { commit: false })"
                        @change="applyNodeFill($event.target.value, { forceCommit: true })"
                      >
                    </label>
                    <label class="inspector-field">
                      <span>Border color</span>
                      <input
                        type="color"
                        :value="selected.item.borderColor"
                        @input="applyNodeBorder($event.target.value, { commit: false })"
                        @change="applyNodeBorder($event.target.value, { forceCommit: true })"
                      >
                    </label>
                  </div>
                  <div class="inspector-grid">
                    <label class="inspector-field">
                      <span>Border width</span>
                      <div class="inspector-slider">
                        <input
                          type="range"
                          min="1"
                          max="8"
                          step="0.5"
                          :value="selected.item.borderWidth"
                          @input="updateNodeBorderWidth($event.target.value, { commit: false })"
                          @change="updateNodeBorderWidth($event.target.value, { forceCommit: true })"
                        >
                        <span>{{ Number(selected.item.borderWidth ?? 3).toFixed(1) }} px</span>
                      </div>
                    </label>
                    <label class="inspector-field">
                      <span>Corner radius</span>
                      <div class="inspector-slider">
                        <input
                          type="range"
                          min="0"
                          max="64"
                          step="1"
                          :value="selected.item.cornerRadius"
                          @input="updateNodeCornerRadius($event.target.value, { commit: false })"
                          @change="updateNodeCornerRadius($event.target.value, { forceCommit: true })"
                        >
                        <span>{{ Math.round(Number(selected.item.cornerRadius ?? 16)) }} px</span>
                      </div>
                    </label>
                  </div>
                  <div class="inspector-grid">
                    <label class="inspector-field">
                      <span>Shape</span>
                      <select
                        class="form-field"
                        :value="selected.item.shape"
                        @change="setNodeShape($event.target.value)"
                      >
                        <option v-for="shape in availableShapes" :key="shape.id" :value="shape.id">
                          {{ shape.label }}
                        </option>
                      </select>
                    </label>
                    <label class="inspector-field">
                      <span>Font size</span>
                      <select
                        class="form-field"
                        :value="selected.item.fontSize"
                        @change="setNodeFontSize($event.target.value)"
                      >
                        <option v-for="option in fontSizeOptions" :key="option.value" :value="option.value">
                          {{ option.label }}
                        </option>
                      </select>
                    </label>
                  </div>
                  <template v-if="selected.item.shape === 'cylinder'">
                    <div class="inspector-grid">
                      <label class="inspector-field">
                        <span>Shape rotation</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="-180"
                            max="180"
                            step="1"
                            :value="Number(selected.item.rotate ?? 0)"
                            @input="updateCylinderRotate($event.target.value, { commit: false })"
                            @change="updateCylinderRotate($event.target.value, { forceCommit: true })"
                          >
                          <span>{{ Number(selected.item.rotate ?? 0).toFixed(0) }}°</span>
                        </div>
                      </label>
                      <label class="inspector-field">
                        <span>Border rotation</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="-180"
                            max="180"
                            step="1"
                            :value="Number(selected.item.shapeBorderRotate ?? 0)"
                            @input="updateCylinderBorderRotate($event.target.value, { commit: false })"
                            @change="updateCylinderBorderRotate($event.target.value, { forceCommit: true })"
                          >
                          <span>{{ Number(selected.item.shapeBorderRotate ?? 0).toFixed(0) }}°</span>
                        </div>
                      </label>
                    </div>
                    <div class="inspector-grid">
                      <label class="inspector-field">
                        <span>Minimum height</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="1"
                            max="50"
                            step="0.1"
                            :value="getCylinderMinimumHeightValue(selected.item)"
                            @input="updateCylinderMinimumHeight($event.target.value, { commit: false })"
                            @change="updateCylinderMinimumHeight($event.target.value, { forceCommit: true })"
                          >
                          <span>{{ formatCylinderMinimumHeight(selected.item) }}</span>
                        </div>
                      </label>
                      <label class="inspector-field">
                        <span>Minimum width</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="1"
                            max="25"
                            step="0.1"
                            :value="getCylinderMinimumWidthValue(selected.item)"
                            @input="updateCylinderMinimumWidth($event.target.value, { commit: false })"
                            @change="updateCylinderMinimumWidth($event.target.value, { forceCommit: true })"
                          >
                          <span>{{ formatCylinderMinimumWidth(selected.item) }}</span>
                        </div>
                      </label>
                    </div>
                    <div class="inspector-grid">
                      <label class="inspector-field">
                        <span>Aspect ratio</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="1"
                            max="10"
                            step="1"
                            :value="getCylinderAspectSliderValue(selected.item)"
                            @input="updateCylinderAspectFromSlider($event.target.value, { commit: false })"
                            @change="updateCylinderAspectFromSlider($event.target.value, { forceCommit: true })"
                          >
                          <span>{{ formatCylinderAspect(selected.item) }}</span>
                        </div>
                      </label>
                      <label class="inspector-field">
                        <span>inner xsep</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="1"
                            max="10"
                            step="0.5"
                            :value="getCylinderInnerSepValue(selected.item, 'innerXsep')"
                            @input="updateCylinderInnerSep('innerXsep', $event.target.value, { commit: false })"
                            @change="updateCylinderInnerSep('innerXsep', $event.target.value, { forceCommit: true })"
                          >
                          <span>{{ formatCylinderInnerSep(selected.item, 'innerXsep') }}</span>
                        </div>
                      </label>
                      <label class="inspector-field">
                        <span>inner ysep</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="1"
                            max="10"
                            step="0.5"
                            :value="getCylinderInnerSepValue(selected.item, 'innerYsep')"
                            @input="updateCylinderInnerSep('innerYsep', $event.target.value, { commit: false })"
                            @change="updateCylinderInnerSep('innerYsep', $event.target.value, { forceCommit: true })"
                          >
                          <span>{{ formatCylinderInnerSep(selected.item, 'innerYsep') }}</span>
                        </div>
                      </label>
                    </div>
                    <div class="inspector-grid">
                      <label class="inspector-field">
                        <span>Preenchimento customizado</span>
                        <select
                          class="form-field"
                          :value="selected.item.cylinderUsesCustomFill ? 'true' : 'false'"
                          @change="updateCylinderCustomFill($event.target.value)"
                        >
                          <option value="true">Ativado</option>
                          <option value="false">Desativado</option>
                        </select>
                      </label>
                      <label class="inspector-field">
                        <span>Cor do corpo</span>
                        <input
                          type="color"
                          :value="selected.item.cylinderBodyFill || selected.item.color || '#f8fafc'"
                          @input="updateCylinderColor('cylinderBodyFill', $event.target.value, { commit: false })"
                          @change="updateCylinderColor('cylinderBodyFill', $event.target.value, { forceCommit: true })"
                        >
                      </label>
                      <label class="inspector-field">
                        <span>Cor da tampa</span>
                        <input
                          type="color"
                          :value="selected.item.cylinderEndFill || selected.item.color || '#f8fafc'"
                          @input="updateCylinderColor('cylinderEndFill', $event.target.value, { commit: false })"
                          @change="updateCylinderColor('cylinderEndFill', $event.target.value, { forceCommit: true })"
                        >
                      </label>
                    </div>
                  </template>
                  <template v-else-if="selected.item.shape === 'rectangle split'">
                    <div class="inspector-grid">
                      <label class="inspector-field">
                        <span>Parts</span>
                        <div class="inspector-slider">
                          <input
                            type="range"
                            min="4"
                            max="6"
                            step="1"
                            :value="Number(selected.item.rectangleSplitParts ?? 4)"
                            @input="updateRectangleSplitParts($event.target.value, { commit: false })"
                            @change="updateRectangleSplitParts($event.target.value, { forceCommit: true })"
                          >
                          <span>{{ Number(selected.item.rectangleSplitParts ?? 4) }}</span>
                        </div>
                      </label>
                    </div>
                  </template>
                  <div class="inspector-actions">
                    <button type="button" class="btn btn-ghost" @click="copySelectedFormatting">Copy formatting</button>
                    <button
                      type="button"
                      class="btn btn-ghost"
                      :disabled="!canPasteFormatting"
                      @click="pasteSelectedFormatting"
                    >
                      Paste formatting
                    </button>
                    <button type="button" class="btn btn-ghost danger" @click="removeSelected">Remove node</button>
                  </div>
                </div>
              </section>

              <section
                class="sidebar-panel"
                v-else-if="selected && selected.type === 'edge'"
              >
                <header><h2>Editar aresta</h2></header>
                <div class="panel-content inspector-content">
                  <div class="inspector-grid">
                    <label class="inspector-field">
                      <span>Line style</span>
                      <select class="form-field" v-model="selected.item.style" @change="onOptionChange">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                      </select>
                    </label>
                    <label class="inspector-field">
                      <span>Direction</span>
                      <select class="form-field" v-model="selected.item.direction" @change="onOptionChange">
                        <option value="->">-&gt;</option>
                        <option value="<->">&lt;-&gt;</option>
                        <option value="-">-</option>
                      </select>
                    </label>
                  </div>
                  <div class="inspector-grid">
                    <label class="inspector-field">
                      <span>Line color</span>
                      <input type="color" v-model="selected.item.color" @input="invalidateTikz" @change="commitHistory">
                    </label>
                    <label class="inspector-field">
                      <span>Path</span>
                      <select class="form-field" v-model="selected.item.shape" @change="onOptionChange">
                        <option value="straight">Straight</option>
                        <option value="90-vertical">90° (vertical first)</option>
                        <option value="90-horizontal">90° (horizontal first)</option>
                        <option value="curva-esquerda">Curve left</option>
                        <option value="curva-direita">Curve right</option>
                      </select>
                    </label>
                  </div>
                  <label
                    class="inspector-field"
                    v-if="selected.item.shape === 'curva-esquerda' || selected.item.shape === 'curva-direita'"
                  >
                    <span>Curvature</span>
                    <div class="inspector-slider">
                      <input
                        type="range"
                        min="10"
                        max="60"
                        v-model="selected.item.bend"
                        @input="invalidateTikz"
                        @change="commitHistory"
                      >
                      <span>{{ selected.item.bend }}°</span>
                    </div>
                  </label>
                  <label class="inspector-field">
                    <span>Edge thickness</span>
                    <div class="inspector-slider">
                      <input
                        type="range"
                        min="1"
                        max="8"
                        step="0.5"
                        :value="selected.item.thickness ?? edgeThickness"
                        @input="updateSelectedEdgeThickness($event.target.value, { commit: false })"
                        @change="updateSelectedEdgeThickness($event.target.value, { forceCommit: true })"
                      >
                      <span>
                        {{
                          selected.item.thickness
                            ? Number(selected.item.thickness).toFixed(1) + ' px'
                            : 'Default: ' + edgeThicknessDisplay
                        }}
                      </span>
                    </div>
                    <button
                      type="button"
                      class="btn btn-ghost mt-2"
                      @click="clearEdgeThickness"
                      :disabled="selected.item.thickness == null"
                    >
                      Use default thickness
                    </button>
                  </label>
                  <div class="inspector-grid" v-if="selected.item.label?.text">
                    <label class="inspector-field">
                      <span>Label color</span>
                      <input
                        type="color"
                        :value="selected.item.label?.color || '#e2e8f0'"
                        @input="updateEdgeLabelColor($event.target.value)"
                        @change="commitHistory"
                      >
                    </label>
                    <label class="inspector-field">
                      <span>Label alignment</span>
                      <select
                        class="form-field"
                        :value="selected.item.label?.alignment || 'auto'"
                        @change="setEdgeLabelAlignment($event.target.value)"
                      >
                        <option value="auto">Automatic</option>
                        <option value="left">Left</option>
                        <option value="center">Centered</option>
                        <option value="right">Right</option>
                      </select>
                    </label>
                  </div>
                  <div class="inspector-actions">
                    <button type="button" class="btn btn-ghost" @click="flipEdgeDirection">Flip direction</button>
                    <button type="button" class="btn btn-ghost" @click="copySelectedFormatting">Copy formatting</button>
                    <button
                      type="button"
                      class="btn btn-ghost"
                      :disabled="!canPasteFormatting"
                      @click="pasteSelectedFormatting"
                    >
                      Paste formatting
                    </button>
                    <button type="button" class="btn btn-ghost danger" @click="removeSelected">Remove edge</button>
                  </div>
                </div>
              </section>
              <section
                class="sidebar-panel"
                v-else-if="selected && selected.type === 'line'"
              >
                <header><h2>Edit line</h2></header>
                <div class="panel-content inspector-content">
                  <div class="inspector-grid">
                    <label class="inspector-field">
                      <span>Line style</span>
                      <select class="form-field" v-model="selected.item.style" @change="onOptionChange">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                      </select>
                    </label>
                    <label class="inspector-field">
                      <span>Line color</span>
                      <input
                        type="color"
                        :value="selected.item.color"
                        @input="updateSelectedLineColor($event.target.value, { commit: false })"
                        @change="updateSelectedLineColor($event.target.value, { forceCommit: true })"
                      >
                    </label>
                  </div>
                  <label class="inspector-field">
                    <span>Line thickness</span>
                    <div class="inspector-slider">
                      <input
                        type="range"
                        min="1"
                        max="8"
                        step="0.5"
                        :value="selected.item.thickness ?? edgeThickness"
                        @input="updateSelectedLineThickness($event.target.value, { commit: false })"
                        @change="updateSelectedLineThickness($event.target.value, { forceCommit: true })"
                      >
                      <span>
                        {{
                          selected.item.thickness
                            ? Number(selected.item.thickness).toFixed(1) + ' px'
                            : 'Default: ' + edgeThicknessDisplay
                        }}
                      </span>
                    </div>
                    <button
                      type="button"
                      class="btn btn-ghost mt-2"
                      @click="clearLineThickness"
                      :disabled="selected.item.thickness == null"
                    >
                      Use default thickness
                    </button>
                  </label>
                  <div class="inspector-actions">
                    <button type="button" class="btn btn-ghost" @click="copySelectedFormatting">Copy formatting</button>
                    <button
                      type="button"
                      class="btn btn-ghost"
                      :disabled="!canPasteFormatting"
                      @click="pasteSelectedFormatting"
                    >
                      Paste formatting
                    </button>
                    <button type="button" class="btn btn-ghost danger" @click="removeSelected">Remove line</button>
                  </div>
                </div>
              </section>

              <section class="sidebar-panel" v-else>
                <header><h2>No element selected</h2></header>
                <div class="empty-state">Select a node, line, or edge to view its properties.</div>
              </section>
            </div>

            <div class="sidebar-body" v-else-if="sidebarTab === 'code'">
              <div class="sidebar-panel space-y-4">
                <header><h2>TikZ code</h2></header>
                <div class="code-panel-toggle space-y-2">
                  <p class="text-sm text-slate-400">
                    Adjust the automatic code refresh through the <strong>Settings</strong> menu in the left sidebar.
                  </p>
                  <p v-if="tikzUpdatePending" class="code-panel-toggle-hint">
                    There are changes not reflected in the code. Turn auto refresh back on to regenerate it.
                  </p>
                </div>
                <textarea readonly :value="tikzCode" aria-label="Generated code" class="code-view"></textarea>
              </div>
            </div>

            <div class="sidebar-body" v-else>
              <div class="sidebar-panel">
                <header class="preview-header">
                  <div>
                    <h2>Preview</h2>
                    <p v-if="isPreviewDirty && tikzCode" class="preview-dirty-hint">
                      There are pending changes. Click <strong>Render</strong> to update.
                    </p>
                  </div>
                  <div class="preview-header-actions">
                    <div class="preview-zoom-controls">
                      <button
                        type="button"
                        class="btn btn-icon"
                        @click="zoomPreviewOut"
                        :disabled="!hasPreviewContent"
                        aria-label="Zoom out preview"
                      >
                        −
                      </button>
                      <span class="preview-zoom-indicator">{{ previewZoomLevel }}%</span>
                      <button
                        type="button"
                        class="btn btn-icon"
                        @click="zoomPreviewIn"
                        :disabled="!hasPreviewContent"
                        aria-label="Zoom in preview"
                      >
                        +
                      </button>
                    </div>
                  </div>
                </header>
                <div class="preview-content">
                  <div class="preview-frame" :style="previewFrameStyle">
                    <div
                      v-if="hasPreviewContent"
                      class="preview-viewport"
                      ref="previewViewportRef"
                      :class="{ 'is-panning': isPreviewPanning }"
                      @pointerdown="onPreviewPointerDown"
                      @pointermove="onPreviewPointerMove"
                      @pointerup="onPreviewPointerUp"
                      @pointercancel="onPreviewPointerCancel"
                      @pointerleave="onPreviewPointerCancel"
                      @wheel="onPreviewWheel"
                      @contextmenu.prevent
                      role="presentation"
                    >
                      <div
                        class="preview-stage"
                        :style="previewStageStyle"
                        ref="previewStageRef"
                      >
                        <div
                          class="preview-stage-content"
                          :style="previewStageContentStyle"
                        >
                          <iframe
                            title="Figure preview"
                            :srcdoc="preview.srcdoc"
                            sandbox="allow-scripts"
                            loading="lazy"
                          ></iframe>
                        </div>
                      </div>
                    </div>
                    <div v-else class="preview-placeholder">
                      The rendered diagram will appear here after you click <strong>Render</strong>.
                    </div>
                    <div
                      v-if="isPreviewLoading"
                      class="preview-loading-overlay"
                      role="status"
                      aria-live="polite"
                    >
                      <div class="preview-loading-bar">
                        <span class="preview-loading-bar-fill"></span>
                      </div>
                      <p class="preview-loading-message">Rendering preview…</p>
                    </div>
                  </div>
                  <div class="preview-actions">
                    <span
                      v-if="isPreviewLoading"
                      class="preview-status"
                      role="status"
                      aria-live="polite"
                    >
                      Rendering preview…
                    </span>
                    <button
                      type="button"
                      class="btn btn-primary preview-render-button"
                      @click="renderPreview"
                      :disabled="!tikzCode || !isPreviewDirty || isPreviewLoading"
                    >
                      {{ isPreviewLoading ? 'Rendering…' : 'Render' }}
                    </button>
                  </div>
                  <button
                    type="button"
                    class="preview-resize-handle"
                    aria-label="Drag or use arrows to adjust the preview height"
                    @pointerdown="startPreviewResize"
                    @keydown.up.prevent="adjustPreviewHeightBy(-24)"
                    @keydown.down.prevent="adjustPreviewHeightBy(24)"
                  >
                    <span class="preview-resize-grip" aria-hidden="true"></span>
                  </button>
                </div>
              </div>
            </div>
          </aside>
        </main>
      </div>
    </div>

    <input
      type="file"
      ref="diagramFileInputRef"
      class="sr-only"
      accept="application/json"
      @change="handleDiagramFileChange"
    >
    <input
      type="file"
      ref="matrixFileInputRef"
      class="sr-only"
      accept=".csv,.txt,text/csv"
      multiple
      @change="handleMatrixFileChange"
    >

    <transition name="fade">
      <div
        v-if="showSettingsDialog"
        id="settings-dialog"
        class="settings-modal-backdrop"
        role="dialog"
        aria-modal="true"
        aria-label="Editor settings"
        @click.self="closeSettingsDialog"
      >
        <section class="settings-modal">
          <header class="settings-modal-header">
            <div>
              <h2>Settings</h2>
              <p>Manage global preferences for the TikZ Editor.</p>
            </div>
            <button type="button" class="btn btn-icon" @click="closeSettingsDialog" aria-label="Close settings">✕</button>
          </header>
          <div class="settings-modal-body">
            <div class="settings-item">
              <div>
                <p class="settings-item-title">Update TikZ automatically</p>
                <p class="settings-item-subtitle">Generate code as you edit the diagram.</p>
              </div>
              <button
                type="button"
                class="settings-switch"
                role="switch"
                :aria-checked="autoUpdateTikz ? 'true' : 'false'"
                @click="toggleAutoUpdateTikz"
                :class="autoUpdateTikz ? 'settings-switch--active' : ''"
              >
                <span class="sr-only">Toggle TikZ auto-update</span>
                <span
                  aria-hidden="true"
                  class="settings-switch-thumb"
                  :class="autoUpdateTikz ? 'settings-switch-thumb--active' : ''"
                ></span>
              </button>
            </div>
            <div class="settings-item">
              <div>
                <p class="settings-item-title">Editor theme</p>
                <p class="settings-item-subtitle">Choose between light or dark mode.</p>
              </div>
              <div class="settings-segmented" role="group" aria-label="Toggle theme">
                <button
                  type="button"
                  :class="{ active: currentTheme === 'dark' }"
                  @click="setTheme('dark')"
                >
                  Dark
                </button>
                <button
                  type="button"
                  :class="{ active: currentTheme === 'light' }"
                  @click="setTheme('light')"
                >
                  Light
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </transition>

    <transition name="fade">
      <div
        v-if="showTemplateBrowser"
        class="template-browser-backdrop"
        role="presentation"
        @click.self="closeTemplateBrowser"
      >
        <section class="template-browser" role="dialog" aria-modal="true" aria-label="Template gallery">
          <header class="template-browser-header">
            <div>
              <h2>Templates</h2>
              <p>Load a ready-made template as a starting point for your diagram.</p>
            </div>
            <button type="button" class="btn btn-icon" @click="closeTemplateBrowser" aria-label="Close templates">✕</button>
          </header>
          <div class="template-browser-list">
            <article v-for="template in templates" :key="template.id" class="template-browser-card">
              <div class="template-card-body">
                <h3>{{ template.name }}</h3>
                <p>{{ template.description }}</p>
              </div>
              <button type="button" class="btn btn-primary" @click="applyTemplate(template.id)">
                Load
              </button>
            </article>
          </div>
        </section>
      </div>
    </transition>

    <transition name="fade">
      <div
        v-if="matrixPrompt.visible"
        class="matrix-import-backdrop"
        role="dialog"
        aria-modal="true"
        aria-label="Provide matrix data"
        @click.self="closeMatrixPrompt"
      >
        <section class="matrix-import-modal matrix-import-modal--prompt">
          <header class="matrix-import-header">
            <div>
              <h2>Import matrix</h2>
              <p>Paste the matrix data or select a TXT/CSV file.</p>
            </div>
            <button
              type="button"
              class="btn btn-icon"
              @click="closeMatrixPrompt"
              aria-label="Cancel matrix import"
            >
              ✕
            </button>
          </header>
          <div class="matrix-import-body matrix-import-body--prompt">
            <label class="matrix-import-label" for="matrix-import-textarea">
              Paste the matrix values below. Use commas, semicolons, or spaces to separate them.
            </label>
            <textarea
              id="matrix-import-textarea"
              ref="matrixPromptTextAreaRef"
              v-model="matrixPrompt.text"
              rows="8"
              spellcheck="false"
              placeholder="1 0 0&#10;0 1 0&#10;0 0 1"
            ></textarea>
            <p v-if="matrixPrompt.error" class="matrix-import-error" role="alert">{{ matrixPrompt.error }}</p>
            <div class="matrix-import-upload">
              <button type="button" class="btn btn-ghost" @click="triggerMatrixFileSelection">
                Choose TXT or CSV file
              </button>
              <p>or paste the contents directly into the field above.</p>
            </div>
          </div>
          <footer class="matrix-import-footer">
            <button type="button" class="btn btn-ghost" @click="closeMatrixPrompt">Cancel</button>
            <button
              type="button"
              class="btn btn-primary"
              @click="confirmMatrixPrompt"
              :disabled="!canSubmitMatrixPrompt"
            >
              Continue
            </button>
          </footer>
        </section>
      </div>
    </transition>

    <transition name="fade">
      <div
        v-if="matrixImport.visible"
        class="matrix-import-backdrop"
        role="dialog"
        aria-modal="true"
        aria-label="Map colors to the imported matrix"
        @click.self="cancelMatrixImport"
      >
        <section class="matrix-import-modal">
          <header class="matrix-import-header">
            <div>
              <h2>Import matrix</h2>
              <p>
                Set colors for each detected value in
                <strong>{{ matrixImport.fileName || 'selected file' }}</strong>.
              </p>
            </div>
            <button
              type="button"
              class="btn btn-icon"
              @click="cancelMatrixImport"
              aria-label="Cancel matrix import"
            >
              ✕
            </button>
          </header>
          <div class="matrix-import-body">
            <p v-if="!matrixImport.values.length" class="matrix-import-empty">
              No values were found in the selected matrix.
            </p>
            <div v-else class="matrix-import-grid" role="list">
              <div
                v-for="value in matrixImport.values"
                :key="`matrix-color-${value}`"
                class="matrix-import-row"
                role="listitem"
              >
                <span class="matrix-import-value" aria-hidden="true">{{ value }}</span>
                <label class="sr-only" :for="`matrix-color-${value}`">
                  Color for value {{ value }}
                </label>
                <input
                  :id="`matrix-color-${value}`"
                  type="color"
                  :value="matrixImport.colorMap[value] || '#000000'"
                  @input="updateMatrixImportColor(value, $event.target.value)"
                >
              </div>
            </div>
          </div>
          <footer class="matrix-import-footer">
            <button type="button" class="btn btn-ghost" @click="cancelMatrixImport">Cancel</button>
            <button
              type="button"
              class="btn btn-primary"
              @click="confirmMatrixImport"
              :disabled="!canConfirmMatrixImport"
            >
              Confirm
            </button>
          </footer>
        </section>
      </div>
    </transition>
  </div>

  <script type="module" src="dist/main.js"></script>
</body>
</html>
